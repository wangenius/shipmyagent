---
title: 上下文工程
description: “Repo is the Agent” 在 ShipMyAgent 里的工程落地方式（Agent.md / .ship / skills / 按需历史）
---

# 上下文工程（Context Engineering）

ShipMyAgent 的核心命题是 **Repo is the Agent**：你的代码仓库不仅是代码，也是 Agent 的上下文与“可审计记忆”。本文解释它在工程上具体怎么实现，以及初始化后项目目录长什么样。

> ⚠️ **简化模式（2026-02-03）**：当前发布的 `shipmyagent` 包已暂时移除 **Tasks/Runs/Scheduler** 与 **审批（Approvals）**（默认全权限执行）。本文只描述当前实现。

## 上下文来自哪里（四层）

从“最稳定”到“最动态”，ShipMyAgent 的上下文可以理解为四层：

1) **项目静态上下文（Repo-level）**
   - `Agent.md`：项目“宪法/角色/边界/行为规范”（系统提示词来源之一）
   - 仓库文件：通过工具按需读取（不会把整个仓库直接塞进提示词）

2) **项目配置上下文（Config-level）**
   - `ship.json`：模型、适配器、技能路径、MCP 等配置
   - 运行时内置默认提示词：`package/src/asset/prompts.txt`

3) **会话动态上下文（Session-level）**
   - 最近对话历史（多轮消息）
   - 运行时元信息（projectRoot/chatKey/requestId/来源渠道等）

## 初始化后目录长什么样

最小可运行项目通常是：

```text
<your-repo>/
├─ Agent.md           # Agent 宪法 / 角色定义
├─ ship.json          # 运行配置
└─ .ship/             # 运行时目录（日志/聊天/缓存…）
```

`.ship/` 典型结构：

```text
.ship/
├─ logs/              # 统一日志（JSONL）
├─ chat/              # 聊天记录（jsonl + archive）
├─ config/            # MCP 配置
├─ schema/            # ship/mcp schema
└─ .cache/            # 幂等/去重/临时缓存
```

## “上下文”在运行时是怎么拼起来的

### 1) system prompt：Agent.md + 内置提示词 + Skills 概览

每次执行都会构建一份 system prompt（示意）：

- 读取项目 `Agent.md`（如果存在）
- 拼上内置默认提示词（行为约束 / 输出规则）
- 扫描并渲染 Skills 概览（默认 `.claude/skills`）

### 2) in-flight messages：DefaultPrompt + history + 用户原文

每次请求发送给模型的输入形态是稳定的：

- `system`：上面这份 system prompt（包含运行时约束，例如“用户可见内容必须通过 `chat_send` 回复”）
- `messages`：来自该 `chatKey` 的 history（`UIMessage[]`），落盘在 `.ship/chat/<encodedChatKey>/messages/history.jsonl`
- 本轮 `user` 消息保持原文（不加前缀）

## 历史太长怎么办（简化版）

当 `system + messages` 接近上下文窗口时，系统会自动 compact：

- 把更早的历史压缩为 1 条摘要消息（assistant）
- 保留最近窗口的原文消息
- 可选归档被折叠的原始段到 `.ship/chat/<encodedChatKey>/messages/archive/*.json`（便于追溯）

## Repo 如何成为上下文（按需检索 + 可审计）

仓库上下文主要通过工具进入 Agent：

- `exec_shell`：在 `projectRoot` 下执行 `ls/cat/rg/git/test/build…`，按需读取/搜索仓库信息
- Skills/MCP：把 SOP 和外部系统能力“工程化地接进来”（`.claude/skills` 与 `.ship/config/mcp.json`）

---

如果你想看更“偏工程实现”的版本（带更多文件路径与职责拆分），可以读仓库内的：
- `docs/context-and-runtime.md`
- `docs/platform-message-pipeline.md`
