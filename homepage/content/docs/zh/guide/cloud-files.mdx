---
title: 云文件（OSS / public）
description: 让文件对外可访问的两种方案：对象存储上传或服务器直出
---

# 云文件（OSS / public）

在一些场景里，你需要把本地文件变成“云上可访问”的 URL，例如：

- 让外部服务/工具通过 URL 拉取文件（如解析 PDF、图片、压缩包）
- 在团队内分享某次运行产物
- 把 Agent 的输出（报告、截图、构建产物）变成可下载链接

ShipMyAgent 提供两种方案：

1. **配置 OSS（S3 兼容）**：通过内置工具把项目内文件上传到对象存储（Cloudflare R2 也属于 S3 兼容）。
2. **部署到服务器并使用 `/public/*`**：把文件放到 `.ship/public/`，由服务器直接通过 `/public/*` 路由对外提供。

同时，ShipMyAgent 也提供了一组面向 Agent 的“云文件工具”，默认策略是：

- **优先 OSS**（若已配置）
- **否则 public**（若已配置 `cloudFiles.publicBaseUrl`）
- 两者都没有则返回失败（“没有设置文件上传路径”）

---

## 方案 1：配置 OSS（启用 `s3_upload`）

### 1) 在 `ship.json` 配置 `oss`

建议用环境变量占位符，避免把密钥写进仓库。并且建议配置默认 bucket，便于高层工具直接 `upload(filePath)`：

```json
{
  "oss": {
    "enabled": true,
    "provider": "s3",
    "endpoint": "${R2_S3_ENDPOINT}",
    "accessKeyId": "${R2_ID}",
    "secretAccessKey": "${R2_SECRET_KEY}",
    "region": "auto",
    "bucket": "my-bucket"
  }
}
```

说明：

- `endpoint`：S3 端点（R2 示例：`https://<account-id>.r2.cloudflarestorage.com`）
- `region`：SigV4 region（R2 通常是 `auto`）
- 当 `oss` 未配置完整，运行时**不会注册** `s3_upload` 这个 tool

### 2) 在 `.env` 提供密钥（本地/服务器环境）

```bash
R2_ID="..."
R2_SECRET_KEY="..."
R2_S3_ENDPOINT="https://<account-id>.r2.cloudflarestorage.com"
```

### 3) 让 Agent 上传文件

你可以直接对 Agent 说：

- “把 `dist/report.pdf` 上传到 bucket `my-bucket`，key 用 `reports/report.pdf`”

Tool 入参等价于：

```json
{
  "bucket": "my-bucket",
  "file": "dist/report.pdf",
  "key": "reports/report.pdf",
  "contentType": "application/pdf"
}
```

> 注意：`file` 必须是**项目目录内**的文件路径（相对项目根目录）。

---

## 方案 2：部署到服务器，通过 `/public/*` 直出 `.ship/public/`

当你把 ShipMyAgent 部署到服务器上时，主服务会提供：

- URL：`/public/<path>`
- 对应磁盘：`.ship/public/<path>`

### 1) 放置文件

```bash
mkdir -p .ship/public
cp /path/to/report.pdf .ship/public/report.pdf
```

### 2) 访问 URL

```text
https://<host>:<port>/public/report.pdf
```

如果你启用了交互式 Web（interactive 端口），交互式端口也会将 `/public/*` 代理到主服务，所以也可以访问同一路径。

---

## 云文件工具（给 Agent 调用）

### 上传：`cloud_file_upload`

最简用法：

```json
{ "filePath": "dist/report.pdf" }
```

返回结果会包含：

- `method`: `oss` 或 `public`
- `url`: 可访问的链接

如果既没配置 `oss`（且没有默认 bucket），也没配置 `cloudFiles.publicBaseUrl`，会返回失败并提示“没有设置文件上传路径”。

### 生成链接：`cloud_file_url`

用于把已知的 `bucket/key` 或 `publicPath` 转成 URL：

```json
{ "method": "public", "publicPath": "uploads/20260101-report.pdf" }
```

### 删除：`cloud_file_delete`

```json
{ "method": "public", "publicPath": "uploads/20260101-report.pdf" }
```

## 安全提示

- `/public/*` 是“公开静态文件”的能力：不要放任何敏感信息（密钥、token、内部数据）。
- 推荐在反向代理（Nginx/Caddy）或网关层加鉴权/白名单；或只在内网访问。
- 当前实现仅允许 `GET`/`HEAD`，并做了路径规范化，避免目录穿越读取项目外文件。
