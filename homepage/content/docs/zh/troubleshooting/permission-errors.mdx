---
title: 权限错误
description: 理解和解决访问控制问题
---

# 权限错误

ShipMyAgent 的权限系统旨在确保安全。本指南帮助您理解和解决与权限相关的问题。

## 理解权限

ShipMyAgent 遵循**最小权限原则**：

```
┌──────────────────────────────────────────────────────┐
│                权限系统                              │
├──────────────────────────────────────────────────────┤
│                                                      │
│  1. 读取权限  → 可以读取仓库文件                    │
│  2. 写入权限 → 可以修改文件（需要批准）              │
│  3. Shell 权限 → 可以执行命令                        │
│  4. 网络权限    → 可以发起 HTTP 请求                 │
│                                                      │
│  ⚠️  高风险操作需要批准                              │
└──────────────────────────────────────────────────────┘
```

## 常见权限错误

### 错误：`zsh: permission denied: shipmyagent`

这通常不是 ShipMyAgent 的权限系统问题，而是 **CLI 入口文件缺少可执行位（`+x`）**。

`pnpm` 有时会把 `node_modules/.bin/shipmyagent` 做成软链并直接指向包里的 `bin/cli.js`；如果目标文件是 `0644`（不可执行），就会出现该错误。

**解决方案**：

```bash
# 修复入口文件的可执行位
chmod +x node_modules/shipmyagent/bin/cli.js

# 或：直接用 node 执行（不依赖可执行位）
node node_modules/shipmyagent/bin/cli.js .
```

### 错误："Permission denied: read access"

**问题**：Agent 无法读取仓库文件。

**诊断**：
```bash
# 检查当前权限
shipmyagent doctor

# 查看权限设置
cat ship.json | grep -A 10 permissions
```

**解决方案**：
```json
{
  "permissions": {
    "read_repo": true  // 启用读取权限
  }
}
```

### 错误："Permission denied: write access"

**问题**：Agent 无法写入文件。

**诊断**：
```bash
# 检查写入权限
shipmyagent logs | grep "write\|permission"

# 测试文件写入
shipmyagent test --operation write
```

**解决方案**：

1. **启用写入权限**：
   ```json
   {
     "permissions": {
       "write_repo": {
         "paths": ["src/**", "docs/**"],  // 指定路径
         "requiresApproval": true  // 需要批准
       }
     }
   }
   ```

2. **添加更多路径**：
   ```json
   {
     "permissions": {
       "write_repo": {
         "paths": [
           "src/**",
           "docs/**",
           "tests/**",
           "*.md"
         ]
       }
     }
   }
   ```

3. **允许所有路径（不推荐）**：
   ```json
   {
     "permissions": {
       "write_repo": {
         "paths": ["**"]  // 所有文件
       }
     }
   }
   ```

### 错误："Permission denied: shell execution"

**问题**：Agent 无法执行 shell 命令。

**解决方案**：
```json
{
  "permissions": {
    "exec_shell": {
      "allow": [
        "ls *",
        "cat *",
        "find *",
        "rg *",
        "grep *",
        "git *",
        "npm *"
      ],
      "requiresApproval": true  // 运行前询问
    }
  }
}
```

### 错误："Approval required but no approval channel"

**问题**：Agent 需要批准但无法请求。

**解决方案**：
```json
{
  "permissions": {
    "write_repo": {
      "paths": ["src/**"],
      "requiresApproval": true
    }
  },
  "integrations": {
    "telegram": {
      "enabled": true,
      "botToken": "${TELEGRAM_BOT_TOKEN}",
      "chatId": "${TELEGRAM_CHAT_ID}"  // 批准所必需
    }
  }
}
```

## 权限系统深入

### 权限级别

| 级别 | 描述 | 使用场景 |
|------|------|----------|
| **读取** | 查看文件 | 代码审查、分析 |
| **写入（自动）** | 无需询问即可修改文件 | 安全路径、受信任的操作 |
| **写入（手动）** | 需要批准才能修改文件 | 有风险的路径、生产代码 |
| **执行** | 运行 shell 命令 | 测试、构建、部署 |
| **网络** | HTTP 请求 | API 调用、webhook |

### 路径匹配

ShipMyAgent 使用 glob 模式进行路径匹配：

```json
{
  "permissions": {
    "write_repo": {
      "paths": [
        "src/**",           // src/ 中的所有文件
        "docs/**/*.md",     // docs/ 中仅 .md 文件
        "tests/*.test.js",  // tests/ 中的测试文件
        "*.json"            // 根目录中的 JSON 文件
      ]
    }
  }
}
```

**模式示例**：
- `**` - 递归匹配所有文件
- `*` - 匹配当前目录中的文件
- `**/*.js` - 匹配所有 .js 文件
- `src/**` - 匹配 src/ 下的所有内容
- `!secret.txt` - 排除特定文件

## 权限问题故障排查

### 问题：Agent 无法读取文件

**症状**：
- "File not found" 错误
- 询问代码时响应为空

**诊断**：
```bash
# 检查读取权限
cat ship.json | jq '.permissions.read_repo'

# 测试文件访问
shipmyagent test --read src/index.js
```

**修复**：
```json
{
  "permissions": {
    "read_repo": true
  }
}
```

### 问题：Agent 无法修改文件

**症状**：
- 尝试编辑时出现 "Permission denied"
- 操作后没有文件被更改

**诊断**：
```bash
# 检查写入路径
cat ship.json | jq '.permissions.write_repo.paths'

# 测试写入访问
shipmyagent test --write test.txt
```

**修复**：
```json
{
  "permissions": {
    "write_repo": {
      "paths": ["**"],  // 或特定路径
      "requiresApproval": false  // 或 true 以手动批准
    }
  }
}
```

### 问题：批准请求不工作

**症状**：
- Agent 等待批准时挂起
- 未收到通知

**诊断**：
```bash
# 检查 Telegram 集成
cat ship.json | jq '.integrations.telegram'

# 测试 Telegram 连接
shipmyagent test --integration telegram
```

**修复**：
1. **确保 Telegram 已配置**：
   ```json
   {
     "integrations": {
       "telegram": {
         "enabled": true,
         "botToken": "${TELEGRAM_BOT_TOKEN}",
         "chatId": "12345678"  // 您的 chat ID
       }
     }
   }
   ```

2. **验证 bot 可以发送消息**：
   ```bash
   curl -X POST "https://api.telegram.org/bot<token>/sendMessage" \
     -d "chat_id=12345678" \
     -d "text=测试消息"
   ```

3. **禁用批准以进行测试**：
   ```json
   {
     "permissions": {
       "write_repo": {
         "requiresApproval": false  // 自动批准
       }
     }
   }
   ```

### 问题：Shell 命令被阻止

**症状**：
- "Command not allowed" 错误
- 测试或构建不运行

**诊断**：
```bash
# 检查允许的命令
cat ship.json | jq '.permissions.exec_shell.allow'

# 测试命令执行
shipmyagent test --exec "npm test"
```

**修复**：
```json
{
  "permissions": {
    "exec_shell": {
      "allow": [
        "ls *",            // 基础探索
        "cat *",
        "find *",
        "rg *",
        "grep *",
        "npm *",           // 所有 npm 命令
        "git *",           // 所有 git 命令
        "node *",          // Node 脚本
        "pytest"           // 特定命令
      ],
      "requiresApproval": false  // 或 true
    }
  }
}
```

## 安全最佳实践

### 1. 使用特定路径

```json
// ❌ 过于宽松
{
  "permissions": {
    "write_repo": {
      "paths": ["**"]
    }
  }
}

// ✅ 更安全
{
  "permissions": {
    "write_repo": {
      "paths": ["src/**", "tests/**"]
    }
  }
}
```

### 2. 对有风险的操作要求批准

```json
{
  "permissions": {
    "write_repo": {
      "paths": ["src/**"],
      "requiresApproval": true  // 修改前询问
    },
    "exec_shell": {
      "allow": ["npm test"],
      "requiresApproval": false  // 安全命令
    }
  }
}
```

### 3. 排除敏感文件

```json
{
  "permissions": {
    "write_repo": {
      "paths": ["**"],
      "exclude": [
        ".env",
        "*.key",
        "secrets/**",
        "config/production.json"
      ]
    }
  }
}
```

### 4. 对密钥使用环境变量

```json
// ❌ 不要硬编码密钥
{
  "llm": {
    "apiKey": "sk-ant-123456789"
  }
}

// ✅ 使用环境变量
{
  "llm": {
    "apiKey": "${ANTHROPIC_API_KEY}"
  }
}
```

## 高级权限模式

### 基于角色的权限

为不同上下文定义不同的权限：

```json
{
  "permissions": {
    "read_repo": true,
    "write_repo": {
      "paths": {
        "development": ["**"],
        "production": ["src/**", "docs/**"]
      },
      "requiresApproval": {
        "development": false,
        "production": true
      }
    }
  },
  "environment": "development"  // 或 "production"
}
```

### 基于时间的权限

将操作限制在特定时间：

```json
{
  "permissions": {
    "write_repo": {
      "paths": ["**"],
      "allowedHours": [9, 10, 11, 12, 13, 14, 15, 16, 17],
      "requiresApproval": true
    }
  }
}
```

### 条件权限

基于条件授予权限：

```json
{
  "permissions": {
    "exec_shell": {
      "allow": ["npm deploy"],
      "conditions": {
        "branch": "main",
        "testsPassed": true,
        "requiresApproval": true
      }
    }
  }
}
```

## 调试权限

### 启用权限日志

```json
{
  "logging": {
    "level": "debug",
    "permissions": {
      "logAll": true,      // 记录所有权限检查
      "logDenials": true   // 记录被拒绝的请求
    }
  }
}
```

### 测试权限

```bash
# 测试所有权限
shipmyagent test --permissions

# 测试特定权限
shipmyagent test --permission write_repo

# 查看权限矩阵
shipmyagent permissions --matrix
```

### 权限审计

审查 agent 可以做什么：

```bash
# 生成权限报告
shipmyagent audit --permissions > permissions-report.txt

# 输出示例：
# 读取访问：已启用
# 写入访问：
#   - src/**：自动批准
#   - docs/**：需要批准
# Shell 访问：
#   - npm test：允许
#   - npm deploy：需要批准
```

## 下一步

- [常见问题](/docs/troubleshooting/common-issues) - 一般故障排查
- [日志与调试](/docs/troubleshooting/logs-debugging) - 理解日志
- [性能问题](/docs/troubleshooting/performance-issues) - 优化技巧
- [配置](/docs/configuration) - 完整配置参考
