---
title: 日志与调试
description: 理解和使用 ShipMyAgent 日志
---

# 日志与调试

有效的调试从理解日志开始。本指南向您展示如何访问、解释和使用 ShipMyAgent 日志。

## 日志位置

日志存储在项目的 `.ship/` 目录中：

```
.ship/
├── logs/
│   └── <YYYY-MM-DD>.jsonl  # 统一 JSONL 日志（系统 + Agent + LLM）
└── chats/                  # 对话消息（jsonl，可归档）
```

## 查看日志

### 直接文件访问

```bash
# 跟踪今天的统一日志文件
tail -f .ship/logs/$(date +%F).jsonl

# 按关键词搜索
grep -i "error\\|warn\\|approval\\|llm" .ship/logs/$(date +%F).jsonl

# 结构化查看（需要 jq）
tail -50 .ship/logs/$(date +%F).jsonl | jq -c '{timestamp, type, message}'
```

## 日志级别

ShipMyAgent 使用标准日志级别：

| 级别 | 描述 | 示例 |
|------|------|------|
| **ERROR** | 阻止操作的错误 | API 失败、权限错误 |
| **WARN** | 不阻止操作的警告 | 弃用的配置、重试尝试 |
| **INFO** | 一般信息 | Agent 已启动、任务完成 |
| **DEBUG** | 详细诊断信息 | 函数调用、变量值 |

### 设置日志级别

ShipMyAgent 当前会把结构化 JSONL 日志写入 `.ship/logs/<YYYY-MM-DD>.jsonl`。

如需控制 LLM 请求日志（通常包含 system + messages），可通过 `ship.json`：

- `llm.logMessages=false` 关闭请求日志

## 解释日志消息

### 日志格式

每个日志条目遵循以下格式：

```
[2024-01-15 14:30:45] [INFO] [AGENT] Agent 启动成功
│                        │      │       │
│                        │      │       └─ 组件 (AGENT, TASK, TELEGRAM)
│                        │      └─ 级别 (INFO, WARN, ERROR, DEBUG)
│                        └─ 时间戳
└─ 日期和时间
```

### 常见日志模式

#### 1. 成功启动

```
[2024-01-15 14:30:45] [INFO] [AGENT] 正在启动 ShipMyAgent v1.0.0
[2024-01-15 14:30:45] [INFO] [CONFIG] 正在从 /path/to/ship.json 加载配置
[2024-01-15 14:30:45] [INFO] [LLM] 已连接到 Anthropic API
[2024-01-15 14:30:46] [INFO] [TELEGRAM] Telegram bot 已连接 (@my_bot)
[2024-01-15 14:30:46] [INFO] [AGENT] Agent 启动成功
```

#### 2. LLM API 错误

```
[2024-01-15 14:35:10] [ERROR] [LLM] API 请求失败：401 Unauthorized
[2024-01-15 14:35:10] [ERROR] [LLM] 请检查 ship.json 中的 API key
[2024-01-15 14:35:10] [DEBUG] [LLM] 响应：{"error":{"message":"invalid credentials"}}
```

#### 3. 权限错误

```
[2024-01-15 14:40:22] [WARN] [PERMISSION] 文件写入访问被拒绝：secret.key
[2024-01-15 14:40:22] [INFO] [PERMISSION] 正在通过 Telegram 请求批准
[2024-01-15 14:40:25] [INFO] [PERMISSION] 收到来自用户：123456 的批准
[2024-01-15 14:40:25] [INFO] [FILE] 成功写入 secret.key
```

#### 4. 任务执行

```
[2024-01-15 18:00:00] [INFO] [TASK] 正在执行任务：daily-report
[2024-01-15 18:00:01] [INFO] [TASK] 任务已开始：daily-report
[2024-01-15 18:00:15] [INFO] [LLM] 正在发送提示到 LLM（256 tokens）
[2024-01-15 18:00:22] [INFO] [TASK] 任务成功完成
[2024-01-15 18:00:22] [INFO] [NOTIFY] 已发送结果到 Telegram
```

## 调试模式

### 启用详细日志

```bash
shipmyagent start
tail -f .ship/logs/$(date +%F).jsonl
```

### 调试输出示例

```
[DEBUG] [HTTP] 收到请求：POST /api/chat
[DEBUG] [HTTP] 请求体：{"message":"hello"}
[DEBUG] [LLM] 正在构造提示...
[DEBUG] [LLM] 提示："你是一个有帮助的助手..."
[DEBUG] [LLM] 正在发送到 API：https://api.anthropic.com/v1/messages
[DEBUG] [HTTP] 响应状态：200
[DEBUG] [LLM] 响应：{"content":"你好！我能帮你什么？"}
[DEBUG] [HTTP] 正在发送响应：200
```

## 常见调试场景

### 场景 1：Agent 无法启动

```bash
# 确认必要文件存在
ls -la Agent.md ship.json

# 查看今天的统一日志
tail -200 .ship/logs/$(date +%F).jsonl
```

### 场景 2：消息没有被处理

```bash
# 确认消息已落盘
ls -la .ship/chats

# 查看某个 chatKey 的最近日志（替换为真实文件名）
tail -50 .ship/chats/<encode(chatKey)>.jsonl

# 查看今天的统一日志
tail -200 .ship/logs/$(date +%F).jsonl
```

### 场景 3：Telegram 无响应

```bash
# 在统一日志里搜索 Telegram 相关关键词
grep -i "telegram\\|webhook\\|getUpdates\\|409\\|conflict" .ship/logs/$(date +%F).jsonl | tail -100

# 3. 测试 Telegram API
curl https://api.telegram.org/bot<BOT_TOKEN>/getMe
```

### 场景 4：性能缓慢

```bash
# 查看今天的统一日志并搜索超时/慢操作关键词
grep -i "timeout\\|too long\\|context_length" .ship/logs/$(date +%F).jsonl | tail -200

# 检查系统资源
top | grep shipmyagent
```

## JSONL 日志分析（jq）

```bash
# 最近 50 条日志的简要视图
tail -50 .ship/logs/$(date +%F).jsonl | jq -c '{timestamp, type, message}'

# 只看 error
jq -c 'select(.type == "error") | {timestamp, message, details}' .ship/logs/$(date +%F).jsonl | tail -200

```

## 保留 / 清理

日志按“每天一个文件”写入 `.ship/logs/`。如需清理旧日志：

```bash
ls -la .ship/logs
rm .ship/logs/2023-*.jsonl
```
