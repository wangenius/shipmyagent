---
title: 架构
description: ShipMyAgent 系统架构和设计原则
---

# 架构

> ⚠️ **简化模式（2026-02-03）**：当前发布的 `shipmyagent` 包已暂时移除 **Tasks/Runs/Scheduler** 与 **审批（Approvals）**（默认全权限执行）。本文档部分内容可能描述的是旧版/规划中的架构。

深入探讨 ShipMyAgent 的架构、设计决策和技术实现。

## 概述

ShipMyAgent 是作为一个模块化、可扩展的 AI agent 系统构建的，专为本地优先的代码仓库自动化而设计。

```
┌─────────────────────────────────────────────────────────────┐
│                      用户界面                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   CLI        │  │   Telegram   │  │   GitHub     │     │
│  │   界面       │  │   Bot        │  │   集成       │     │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │
│         │                  │                  │               │
│         └──────────────────┼──────────────────┘               │
│                            │                                  │
│                    ┌───────▼────────┐                         │
│                    │  Agent 核心    │                         │
│                    │  (编排器)      │                         │
│                    └───────┬────────┘                         │
│                            │                                  │
│         ┌──────────────────┼──────────────────┐              │
│         │                  │                  │              │
│    ┌────▼────┐      ┌─────▼─────┐     ┌─────▼─────┐          │
│    │  任务    │      │   LLM     │     │  工具     │          │
│    │  调度器  │      │  提供商   │     │  执行器   │          │
│    └─────────┘      └───────────┘     └───────────┘          │
│                                                               │
└─────────────────────────────────────────────────────────────┘
                            │
                            │
┌───────────────────────────▼──────────────────────────────┐
│                   仓库接口                               │
│  - 文件系统  - Git 操作  - Shell 命令                      │
└────────────────────────────────────────────────────────────┘
```

---

## 核心组件

### 1. Agent 核心（编排器）

管理所有 agent 操作的中央协调器。

**职责**：
- 解析和执行用户命令
- 协调 LLM 和工具交互
- 管理权限检查
- 处理任务调度
- 路由通知
- 管理对话上下文和长期记忆

**关键设计决策**：
- **对话隔离**：每个 chatKey（chat/thread）独立管理上下文
- **基于插件**：工具和 LLM 提供商可插拔
- **权限优先**：所有操作都经过权限检查
- **智能上下文管理**：自动压缩和记忆提取

### 2. LLM 提供商抽象

为多个 LLM 提供商提供统一接口。

**接口**：
```typescript
interface LLMProvider {
  chat(params: ChatParams): Promise<ChatResponse>
  stream(params: ChatParams): AsyncIterator<ChatChunk>
  validate(): Promise<boolean>
  estimateTokens(text: string): number
}
```

**设计好处**：
- 易于添加新提供商
- 故障转移和负载平衡
- 无论提供商如何，API 一致

### 3. 工具系统

可扩展的工具框架，用于 agent 能力。

**内置工具**：
- `read_file`：读取仓库文件
- `write_file`：写入文件
- `exec_shell`：执行 shell 命令
- `git_op`：Git 操作
- `search`：搜索代码库

**工具接口**：
```typescript
interface Tool {
  name: string
  description: string
  parameters: ToolParameters
  execute(params: any, context: Context): Promise<ToolResult>
  validate(params: any): boolean
}
```

### 4. 权限系统

安全的细粒度访问控制。

**权限层**：
1. **文件系统**：读/写路径，glob 模式
2. **Shell**：命令白名单/黑名单
3. **网络**：API 端点限制
4. **人工批准**：需要确认的操作

**设计原则**：
- **最小权限**：默认拒绝，显式允许
- **审计跟踪**：所有操作都被记录
- **可撤销**：易于撤销权限

---

## 上下文管理系统（简化版）

当前 runtime 采用更可预测、更低成本的上下文策略：

- 每次请求拼一个 **system**：`Agent.md + DefaultPrompt`
- **user** 消息保持原文（不加前缀）
- 上下文默认来自按 `chatKey` 隔离的 in-memory session history（裁剪到固定上限）
- 需要更多落盘历史细节时，模型可调用 `chat_load_history` 从 `.ship/chat/<chatKey>/conversations/history.jsonl` 加载并注入到当前上下文

### 存储位置（当前）

```text
.ship/
  logs/       # 执行/审计日志（JSONL）
  chats/      # 对话历史（JSONL，append-only）
  mcp/        # MCP 配置/状态（可选）
  .cache/     # 临时缓存（幂等等）
```

---

## 安全架构

### 威胁模型

**潜在威胁**：
1. **提示注入**：恶意用户试图绕过限制
2. **未授权访问**：Agent 访问敏感资源
3. **代码执行**：运行恶意 shell 命令
4. **数据泄露**：窃取机密或敏感数据

### 缓解策略

#### 1. 权限验证

每个操作都经过检查。

#### 2. 提示清理

在发送到 LLM 之前验证用户输入。

#### 3. 沙箱执行

在受控环境中执行 shell 命令。

#### 4. 审计日志

所有敏感操作都被记录。

---

## 性能考虑

### 优化策略

#### 1. 响应缓存

缓存 LLM 响应以避免重复调用。

#### 2. 流式响应

流式传输 LLM 响应以获得更好的用户体验。

#### 3. 并行工具执行

并行执行独立的工具。

#### 4. 连接池

重用连接以减少开销。

### 性能基准

| 操作 | 时间 | 说明 |
|------|------|------|
| 简单聊天查询 | 1‑3秒 | 取决于 LLM |
| 代码审查（100 行）| 5‑15秒 | 分析整个文件 |
| 文件搜索 | `<1秒` | 使用 ripgrep |
| Shell 命令 | 可变 | 取决于命令 |
| 任务执行 | 10‑60秒 | 复杂任务 |

---

## 可扩展性

### 插件系统

ShipMyAgent 支持自定义工具和提供商。

#### 自定义工具

```typescript
// custom-tool.ts
export class MyCustomTool extends Tool {
  name = 'my_tool';

  async execute(params: { input: string }) {
    // 自定义逻辑
    return {
      success: true,
      data: process(params.input)
    };
  }
}
```

#### 自定义 LLM 提供商

```typescript
// custom-provider.ts
export class CustomLLM extends LLMProvider {
  async chat(params: ChatParams) {
    // 自定义 API 调用
    const response = await fetch(this.baseUrl, {
      method: 'POST',
      body: JSON.stringify(params)
    });
    return await response.json();
  }
}
```

---

## 配置加载

### 配置层次

```
1. ship.json（基础配置）
       ↓
2. 环境变量（覆盖）
       ↓
3. CLI 标志（临时覆盖）
       ↓
4. 运行时配置（最终状态）
```

---

## 错误处理

### 错误类别

1. **用户错误**：无效输入、权限问题
2. **系统错误**：LLM API 失败、网络问题
3. **任务错误**：任务执行失败

---

## 监控和可观测性

### 收集的指标

- **操作计数**：工具使用、任务运行
- **性能**：响应时间、LLM 延迟
- **错误**：失败率、错误类型
- **资源使用**：内存、CPU

### 健康检查

```bash
shipmyagent doctor

# 输出：
✅ 配置：有效
✅ LLM 连接：OK
✅ 文件权限：OK
✅ Git 仓库：OK
⚠️  任务队列：3 个任务失败
✅ 集成状态：全部已连接
```

---

## 可扩展性

### 水平扩展

ShipMyAgent 设计用于单个仓库。对于多个仓库：

```bash
# 运行多个实例
shipmyagent start --project /path/repo1 --port 3000 &
shipmyagent start --project /path/repo2 --port 3001 &
```

### 垂直扩展

对于大型仓库：

```json
{
  "performance": {
    "maxConcurrentTasks": 10,
    "llmPoolSize": 5,
    "cacheSize": "2GB",
    "workerThreads": 4
  }
}
```

---

## 下一步

- [自定义](/docs/customization) - 构建自定义工具和插件
- [API 参考](/docs/reference/api) - 可扩展性 API
- [贡献](/docs/community/contributing) - 架构贡献指南
